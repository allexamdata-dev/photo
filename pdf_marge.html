<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Merger & Compressor</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; color: #333; }
        .main-wrapper { display: flex; gap: 20px; max-width: 1100px; margin: auto; height: 90vh; }
        
        /* Left Panel */
        .controls-container { flex: 1; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Buttons */
        .btn-add { background-color: #5cb85c; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 20px; transition: 0.3s; }
        .btn-add:hover { background-color: #4cae4c; }
        
        .btn-merge { background-color: #007bff; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: auto; }
        .btn-merge:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* File List */
        #file-list { list-style: none; padding: 0; overflow-y: auto; flex-grow: 1; }
        .file-item { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #dfe6e9; padding: 12px; border-radius: 8px; margin-bottom: 10px; transition: 0.2s; }
        .file-item:hover { border-color: #b2bec3; }
        .file-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        
        .action-btns { display: flex; gap: 8px; }
        .btn-view { background: #5bc0de; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-del { background: #d9534f; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; }

        /* Right Panel: Preview */
        .preview-container { flex: 1.5; background: #2f3640; border-radius: 12px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        #preview-frame { width: 100%; height: 100%; border: none; background: #fff; display: none; }
        .no-preview { color: #95a5a6; font-size: 18px; text-align: center; padding: 20px; }
        #color{color:white;}
        #status-msg { font-size: 13px; text-align: center; margin-top: 10px; color: #7f8c8d; }
	.image_marge{background-color: #5cb85c; border: none; padding:15px 12px; border-radius: 8px;
         font-size: 15px; align-items:center; display:flex; font-weight: bold; cursor: pointer; margin-bottom: 520px; transition: 0.3s; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="controls-container">
        <h2>Merge PDFs</h2>
        <input type="file" id="pdf-input" accept="application/pdf" style="display: none;">
        <button class="btn-add" onclick="document.getElementById('pdf-input').click()">ADD PDF FILE</button>

        <div id="file-list">
            </div>

        <button id="merge-btn" class="btn-merge" disabled>Merge & Download</button>
        <div id="status-msg">Add at least 2 files to begin</div>
    </div>

    <div class="preview-container">
        <div class="no-preview" id="placeholder">Select a file to preview it here</div>
        <iframe id="preview-frame"></iframe>
    </div>
     <div class="image_marge">
        <a id="color" href="/practice/index.html" alt="image editor">MOVE TO IMAGE EDITOR</a>
     </div>

</div>
<script>
    const { PDFDocument } = PDFLib;
    let pdfFiles = [];

    const fileInput = document.getElementById('pdf-input');
    const fileListDiv = document.getElementById('file-list');
    const mergeBtn = document.getElementById('merge-btn');
    const previewFrame = document.getElementById('preview-frame');
    const placeholder = document.getElementById('placeholder');
    const statusMsg = document.getElementById('status-msg');

    // Add file one-by-one
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type === "application/pdf") {
            pdfFiles.push(file);
            renderFiles();
        }
        fileInput.value = ""; // Clear input for same file re-selection
    });

    // Render the list with the ❌ button
    function renderFiles() {
        fileListDiv.innerHTML = "";
        pdfFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = "file-item";
            item.innerHTML = `
                <span class="file-name">${index + 1}. ${file.name}</span>
                <div class="action-btns">
                    <button class="btn-view" onclick="viewFile(${index})">View</button>
                    <button class="btn-del" onclick="deleteFile(${index})">❌</button>
                </div>
            `;
            fileListDiv.appendChild(item);
        });

        // Enable/Disable merge button
        mergeBtn.disabled = pdfFiles.length < 2;
        statusMsg.innerText = pdfFiles.length < 2 ? "Add at least 2 files" : `${pdfFiles.length} files ready`;
    }

    // Delete a specific file
    window.deleteFile = (index) => {
        pdfFiles.splice(index, 1);
        renderFiles();
        // Hide preview if list is empty
        if (pdfFiles.length === 0) {
            previewFrame.style.display = "none";
            placeholder.style.display = "block";
        }
    };

    // View file in the right panel
    window.viewFile = (index) => {
        const url = URL.createObjectURL(pdfFiles[index]);
        previewFrame.src = url;
        previewFrame.style.display = "block";
        placeholder.style.display = "none";
    };

    // Final Merge and Compression
    mergeBtn.addEventListener('click', async () => {
        statusMsg.innerText = "Processing... reducing size...";
        mergeBtn.disabled = true;

        try {
            const mergedDoc = await PDFDocument.create();

            for (const file of pdfFiles) {
                const existingPdfBytes = await file.arrayBuffer();
                const pdf = await PDFDocument.load(existingPdfBytes);
                const copiedPages = await mergedDoc.copyPages(pdf, pdf.getPageIndices());
                
                copiedPages.forEach((page) => {
                    // Slight scaling helps reduce metadata and size
                    page.scale(0.85, 0.85);
                    mergedDoc.addPage(page);
                });
            }

            // Save with object streams to compress
            const mergedPdfBytes = await mergedDoc.save({ useObjectStreams: true });
            
            const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
            const finalSize = (blob.size / 1024).toFixed(1);

            // Trigger Download
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "merged_and_compressed.pdf";
            link.click();

            statusMsg.innerText = `Success! Final Size: ${finalSize} KB`;
        } catch (error) {
            console.error(error);
            statusMsg.innerText = "Error merging PDF.";
        } finally {
            mergeBtn.disabled = false;
        }
    });
</script>

</body>
</html>
